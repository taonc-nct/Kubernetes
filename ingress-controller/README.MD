# INGRESS IN KUBERNETES

## 1. Ingress l√† g√¨?. T·∫°i sao l·∫°i c·∫ßn ph·∫£i s·ª≠ d·ª•ng ingress?
- ch√∫ng ta ƒë√£ bi·∫øt 4 lo·∫°i service type v√† c√°ch s·ª≠ d·ª•ng ch√∫ng. Trong ƒë√≥ ƒë·ªÉ expose ·ª©ng d·ª•ng ra b√™n ngo√†i th√¨ ch·ªâ c√≥ NodePort v√† LoadBalancer (tr√™n onprem th√¨ 2 lo·∫°i n√†y coi nh∆∞ 1).
#### S·ª≠ d·ª•ng NodePort c√≥ m·ªôt s·ªë h·∫°n ch·∫ø:
- ervice ƒë∆∞·ª£c expose ho√†n to√†n ra b√™n ngo√†i
Ph·∫£i s·ª≠ d·ª•ng qua port NodePort (thay v√¨ s·ª≠ d·ª•ng port http/https cho c√°c ·ª©ng d·ª•ng web th√¨ ph·∫£i th√™m c√°i ƒëu√¥i NodePort v√†o sau domainname --> Nh√¨n n√≥ k√©m chuy√™n nghi·ªáp th·∫≠t s·ª± üòÑ)
S·ªë l∆∞·ª£ng Port s·ª≠ d·ª•ng cho NodePort h·∫°n ch·∫ø (m·∫∑c ƒë·ªãnh range NodePort t·ª´ 30000-32767)
#### Kubernetes Ingress s·∫Ω gi√∫p gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√™u tr√™n:

- C√°c service ·ª©ng d·ª•ng s·∫Ω ƒë∆∞·ª£c expose d∆∞·ªõi d·∫°ng ClusterIP v√† sau ƒë√≥ ƒë∆∞·ª£c expose ra b√™n ngo√†i qua Ingress --> Service th·ª±c s·ª± trong su·ªët v·ªõi ng∆∞·ªùi d√πng. Ng∆∞·ªùi d√πng ch·ªâ th·ª±c s·ª± k·∫øt n·ªëi t·ªõi Ingress Controller
C√≥ th·ªÉ d√πng th√™m external LoadBalancer b√™n ngo√†i ƒë·ªÉ tr·ªè t·ªõi IngressController --> C√≥ th·ªÉ s·ª≠ d·ª•ng port http/https ƒë·ªÉ k·∫øt n·ªëi t·ªõi domain t∆∞∆°ng ·ª©ng c·ªßa service thay v√¨ ph·∫£i ch·ªâ ƒë·ªãnh th√™m NodePort, nh√¨n n√≥ chuy√™n nghi·ªáp h∆°n h·∫≥n
Kh√¥ng b·ªã h·∫°n ch·∫ø b·ªüi s·ªë l∆∞·ª£ng Port m√† NodePort c√≥ th·ªÉ cung c·∫•p.
## 2. C∆° ch·∫ø ho·∫°t ƒë·ªông c·ªßa Kubernetes Ingress.

#### C∆° ch·∫ø ho·∫°t ƒë·ªông c·ªßa Ingress g·ªìm 2 th√†nh ph·∫ßn ch√≠nh:

- Ingress Controller: L√† th√†nh ph·∫ßn ƒëi·ªÅu khi·ªÉn ch√≠nh l√†m nhi·ªám v·ª• ƒëi·ªÅu h∆∞·ªõng c√°c request t·ªõi c√°c service b√™n trong k8s. Th∆∞·ªùng th√¨ Ingress Controller ƒë∆∞·ª£c c√†i ƒë·∫∑t tr√™n K8S v√† ƒë∆∞·ª£c expose ra ngo√†i d∆∞·ªõi d·∫°ng NodePort.

- Ingress Rule: L√† m·ªôt t√†i nguy√™n tr√™n K8S. N√≥ ch·ª©a n·ªôi dung khai b√°o rule ƒë·ªÉ ƒëi·ªÅu h∆∞·ªõng t·ª´ m·ªôt request t·ªõi m·ªôt service c·ª• th·ªÉ tr√™n trong K8S.

- **NOTE**: C√≥ nhi·ªÅu Ingress Controller t·ª´ c√°c nh√† ph√°t tri·ªÉn kh√°c b·∫°n c√≥ th·ªÉ l·ª±a ch·ªçn ƒë·ªÉ c√†i ƒë·∫∑t. Ngo√†i ra tr√™n k8s c≈©ng h·ªó tr·ª£ c√†i ƒë·∫∑t nhi·ªÅu Ingress Controller t√πy nhu c·∫ßu s·ª≠ d·ª•ng. Trong b√†i n√†y s·∫Ω ch·ªâ ƒë·ªÅ c·∫≠p ƒë·∫øn Nginx ingress.

    ![alt text](image/traffic.png)

## 3. Ingress

### Ph√¢n lo·∫°i
- Ingress l√† m·ªôt t√†i nguy√™n ·ªü m·ª©c Namespace tr√™n K8S. V√† gi·ªëng nh∆∞ c√°c t√†i nguy√™n kh√°c nh∆∞ Pod, Deployment hay Service, ta c√≥ th·ªÉ ƒë·ªãnh nghƒ©a n√≥ b·∫±ng c√°ch s·ª≠ d·ª•ng file manifest d·∫°ng yaml. C√≥ m·ªôt s·ªë c√°ch ƒë·ªãnh tuy·∫øn: ƒê·ªãnh tuy·∫øn d·ª±a tr√™n URL, ƒê·ªãnh tuy·∫øn d·ª±a tr√™n host,ƒê·ªãnh tuy·∫øn b·∫£o m·∫≠t TLS

#### ƒê√¢y l√† ƒë·ªãnh tuy·∫øn theo host:

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-resource-1
spec:
  ingressClassName: nginx
  rules:
  - host: taonc.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-deploy-main
            port: 
              number: 80
```

C·∫•u h√¨nh Ingress ƒë·ªÉ ƒë·ªãnh tuy·∫øn l∆∞u l∆∞·ª£ng truy c·∫≠p t·ª´ domain "taonc.example.com" ƒë·∫øn Service "nginx-deploy-main" trong namespace default. 

#### ƒê√¢y l√† ƒë·ªãnh tuy·∫øn theo URL:

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: minimal-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx-example
  rules:
  - http:
      paths:
      - path: /testpath
        pathType: Prefix
        backend:
          service:
            name: test
            port:
              number: 80
```
√ù nghƒ©a c·ªßa khai b√°o tr√™n l√† m·ªçi request t·ªõi m√† c√≥ Path ch·ª©a Prefix l√† /testpath th√¨ s·∫Ω ƒë∆∞·ª£c forward t·ªõi servcie test ·ªü port 80.

#### ƒê·ªãnh tuy·∫øn b·∫£o m·∫≠t TLS:
N·∫øu  c·∫ßn ƒë·∫£m b·∫£o t√≠nh ri√™ng t∆∞ v√† b·∫£o m·∫≠t cho l∆∞u l∆∞·ª£ng truy c·∫≠p v√†o d·ªãch v·ª• , c√≥ th·ªÉ s·ª≠ d·ª•ng Ingress ƒë·ªÉ c·∫•u h√¨nh ƒë·ªãnh tuy·∫øn b·∫£o m·∫≠t TLS. D∆∞·ªõi ƒë√¢y l√† m·ªôt v√≠ d·ª• v·ªÅ c√°ch c·∫•u h√¨nh Ingress ƒë·ªÉ ƒë·ªãnh tuy·∫øn l∆∞u l∆∞·ª£ng truy c·∫≠p b·∫£o m·∫≠t t·ª´ domain "foo.bar.com" ƒë·∫øn Service "service1" trong namespace default v√† s·ª≠ d·ª•ng ch·ª©ng ch·ªâ TLS:

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: example-ingress
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/issuer: "letsencrypt-prod"
spec:
  tls:
    - hosts:
        - foo.bar.com
      secretName: example-tls
  rules:
    - host: foo.bar.com
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: service1
                port:
                  number: 80
```

- ·ªû tr√™n l√† 3 ph∆∞∆°ng ph√°p s·ª≠ d·ª•ng ingress kh√°c nhau, tuy v·∫≠y ch√∫ng ƒë·ªÅu c√≥ m·ªôt ph·∫ßn chung l√† **rules**. Ta s·∫Ω t√¨m hi·ªÉu v·ªÅ ch√∫ng.

### Ingress Rules
##### Path Type
- Prefix
- Exact
- ImplementationSpecific

Gi·∫£i th√≠ch h·∫øt b·ªçn n√†y kh√° kh√≥ hi·ªÉu thay v√†o ƒë√≥ ta xem m·ªôt s·ªë c√°ch s·ª≠ d·ª•ng c·ªßa ch√∫ng ƒë∆∞·ª£c cung c·∫•p b·ªüi kubernetes: 
![alt text](image/type-path1.png)
![alt text](image/type-path2.png)

## 4. Example
Trong v√≠ d·ª• n√†y ta s·∫Ω ƒë·ªÅ s·ª≠ d·ª•ng load balancer nh∆∞ng v√¨ kh√¥ng c√≥ ti·ªÅn n√™n s·ª≠ d·ª•ng metallb ƒë·ªÉ thay th·∫ø
#### Tri·ªÉn khai metallb
```
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/manifests/metallb-native.yaml
```
X√©t r·∫£i IP cho loab balancer. D√£i ip ph·∫£i c√πng r·∫£i c·ªßa node v√† d·∫£i ip ph·∫£i l√† ip ch∆∞a ƒë∆∞·ª£c s·ª≠ d·ª•ng

```
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: first-pool
  namespace: metallb-system
spec:
  addresses:
  - 172.30.1.9-172.30.1.10
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: example
  namespace: metallb-system
```
- Sau khi tri·ªÉn khai metallb xong th√¨ ta s·∫Ω c√≥ m·ªôt ƒë·ªãa ch·ªâ load balancer (**172.30.1.9**)
![alt text](image/1.png)
### Tri·ªÉn khai demo
- Nginx ingress th√¨  d√πng helm tri·ªÉn khai n√™n ta ƒëi tr·ª±c ti·∫øp v√†o v√≠ d·ª•:

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    run: nginx
  name: nginx-deploy-main
spec:
  replicas: 1
  selector:
    matchLabels:
      run: nginx-main
  template:
    metadata:
      labels:
        run: nginx-main
    spec:
      containers:
      - image: nginx
        name: nginx
---
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: "2024-06-18T15:52:50Z"
  labels:
    run: nginx
  name: nginx-deploy-main
  namespace: default
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  selector:
    run: nginx-main
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: {}
```
```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-resource-1
spec:
  ingressClassName: nginx
  rules:
  - host: taonc.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-deploy-main
            port: 
              number: 80
```
- Ta c√≥ m·ªôt deployment v√† m·ªôt service t∆∞∆°ng ·ª©ng. 
- Tri·ªÉn khai th√™m m·ªôt ingress. Ingress s·∫Ω foward t·ª´ LB c·ªßa metallb(**172.30.1.9**) ƒë·∫øn service **nginx-deploy-main** . L√∫c n√†y **taonc.example.com** ƒë√≥ng vai tr√≤ l√† **172.30.1.9**. N·∫øu l√† n·ªÅn t·∫£ng cloud th√¨ kh√¥ng c·∫ßn ph·∫£i config host nh∆∞ng ƒë√¢y l√† on-prime n√™n ta ph·∫£i set hosts.

![alt text](image/2.png)

- curl th·ª≠ nh√°.

![alt text](image/3.png)

>> Gi·ªù t·∫•t c·∫£ d·ªØ li·ªáu tr·ªè v√†o **taonc.example.com**  s·∫Ω ƒë∆∞·ª£c ingress foward ƒë·∫øn service **nginx-deploy-main**

- X√≥a ingress ƒë·∫ßu ti√™n nh√°:
```
k delete ing ingress-resource-1
```
- Tri·ªÉn khai th√™m hai deploy **Blue** v√† **Green** :
```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    run: nginx
  name: nginx-deploy-blue
spec:
  replicas: 1
  selector:
    matchLabels:
      run: nginx-blue
  template:
    metadata:
      labels:
        run: nginx-blue
    spec:
      volumes:
      - name: webdata
        emptyDir: {}
      initContainers:
      - name: web-content
        image: busybox
        volumeMounts:
        - name: webdata
          mountPath: "/webdata"
        command: ["/bin/sh", "-c", 'echo "<h1>I am <font color=blue>BLUE</font></h1>" > /webdata/index.html']
      containers:
      - image: nginx
        name: nginx
        volumeMounts:
        - name: webdata
          mountPath: "/usr/share/nginx/html"

```

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    run: nginx
  name: nginx-deploy-green
spec:
  replicas: 1
  selector:
    matchLabels:
      run: nginx-green
  template:
    metadata:
      labels:
        run: nginx-green
    spec:
      volumes:
      - name: webdata
        emptyDir: {}
      initContainers:
      - name: web-content
        image: busybox
        volumeMounts:
        - name: webdata
          mountPath: "/webdata"
        command: ["/bin/sh", "-c", 'echo "<h1>I am <font color=green>GREEN</font></h1>" > /webdata/index.html']
      containers:
      - image: nginx
        name: nginx
        volumeMounts:
        - name: webdata
          mountPath: "/usr/share/nginx/html"

```
- Apply new ingress

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-resource-2
spec:
  ingressClassName: nginx
  rules:
  - host: taonc.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-deploy-main
            port:
              number: 80
  - host: blue.taonc.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-deploy-blue
            port:
              number: 80
  - host: green.taonc.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-deploy-green
            port:
              number: 80

```
- Ki·ªÉm tra m·ªõi bi·∫øt l√† l·ªói.

![alt text](image/4.png)

- Qu√™n ch∆∞a expose service c·ªßa hai th·∫±ng deployment ·ªü tr√™n
```
k expose deploy nginx-deploy-blue --port 80
```
```
k expose deploy nginx-deploy-green --port 80
```
- check l·∫°i.

![alt text](image.png)

- Set l·∫°i /etc/hosts v√† curl th·ª≠ th√¥i.

![alt text](image/6.png)

> ƒë·ªÉ tr√°nh tr∆∞·ªùng h·ª£p l√† bao nhi√™u host l·∫°i ph·∫£i th√™m v√†o v√≠ d·ª• c√≥ yellow, black th√¨ kh√¥ng c·∫ßn ph·∫£i x√©t host m·ªôt c√°ch c·ª±c ƒëoan nh∆∞ v·∫≠y.

- Ta x·ª≠ d·ª•ng annotation m·ªõi c·ªßa ingress nginx: **nginx.ingress.kubernetes.io/rewrite-target: /**

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
  name: ingress-resource-3
spec:
  ingressClassName: nginx
  rules:
  - host: taonc.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-deploy-main
            port:
              number: 80
      - path: /blue
        pathType: Prefix
        backend:
          service:
            name: nginx-deploy-blue
            port:
              number: 80
      - path: /green
        pathType: Prefix
        backend:
          service:
            name: nginx-deploy-green
            port:
              number: 80

```
- L√∫c n√†y file hosts c·ªßa ch√∫ng ta s·∫Ω nh∆∞ sau.
![alt text](image/2.png)
- ƒê·ªÉ truy c·∫≠p v√†o blue th√¨: **taonc.example.blue**